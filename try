<!DOCTYPE html>
<html>
<head>
    <title>Buy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Cart Details</h1>
        <form  action="/billing" method="post">
        <input type="hidden" name="_token" value="{{ csrf_token() }}">
        
            <ul id="cartItemsList">
            @foreach($data as $item)
            <li>

            <div class="card" style="background-color: light;">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <img src="{{ asset('storage/images/'.$item->carts_image) }}" class="card-img-top" alt="Item Image" style="width: 80px; height: auto">
                        </div>
                        <div class="col-md-6">
                            <h4 class="card-title">Order Name: {{ $item->items->itemName}}</h4>
                            <div class="input-group">
                                Quantity:
                                <input type="number" onclick="updateQuantity(this.value,this)" name="quantityInput_{{ $item->id }}" value="{{ $item->carts_quantity }}" min="0" max="{{ $item->carts_quantity }}" id="{{$item->id}}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <p class="card-text">Price: {{ $item->carts_price }}</p>
                        </div>
                        
                    </div>
                </div>
            </div>
        </li>
        <br>
        @endforeach
    </ul>
    <div class="text-center">
                <button type="submit" class="btn btn-warning d-block mx-auto d-lg-inline-block mb-3 mb-md-0 ml-md-auto mr-md-auto">Proceed to Buy</button>
            </div>
</form>
<span class="col-md-1">
<a href="/carts/{{ $item->id }}" class="btn btn-danger">Delete</a>
</span>
</div>
<script>
    function updateQuantity(quantity,id) {
        // console.log(id.id);

        var final_id=id.id;
        $.ajaxSetup({
   headers: {
     'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
   }
});
        
        $.ajax({
            url: 'updatequantity/' + final_id,
            type: 'post',
            data: {
                "_token": "{{ csrf_token() }}",
                'quantity': quantity
            },
            success: function(response) {
                console.log(response);
                // Update the quantity in the database
            },
            // error: function(xhr, status, error) {
            //     console.log(xhr.responseText);
            // }
        });
    }
</script>
</body>
</html>
<!-- tis is buy.blade.php file -->
<!-- <!DOCTYPE html>
<html>
<head>
    <title>Buy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: lightgray;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cart Details</h1>
        <input type="hidden" name="_token" value="{{ csrf_token() }}">
        
        <ul id="cartItemsList">
            @foreach($data as $item)
            <li>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="{{ asset('storage/images/'.$item->carts_image) }}" class="card-img-top" alt="Item Image" style="width: 80px; height: auto">
                            </div>
                            <div class="col-md-6">
                                <h4 class="card-title">Order Name: {{ $item->items->itemName}}</h4>
                                <div class="input-group">
                                    Quantity:
                                    <input type="number" onclick="updateQuantity(this.value, this)" name="quantityInput_{{ $item->id }}" value="1" min="1" max="{{ $item->carts_quantity }}" id="{{$item->id}}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <p class="card-text">Price: {{ $item->carts_price }}</p>
                            </div>
                            <div class="col-md-12">
                                <form action='carts/{{$item->id}}' method='post'>
                                    @csrf
                                    @method('delete')
                                    <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
            <br>
            @endforeach
        </ul>
      
        <div class="text-center">
            @if(count($data) > 0)
                <a href='/billing' class="btn btn-warning d-block mx-auto d-lg-inline-block mb-3 mb-md-0 ml-md-auto mr-md-auto" onclick="updateQuantity(1, this)">Proceed to Buy</a>
            @endif
        </div>

        <script>
            function updateQuantity(quantity, element) {
                var final_id = element.id;
                $.ajaxSetup({
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    }
                });
                
                $.ajax({
                    url: 'updatequantity/' + final_id,
                    type: 'post',
                    data: {
                        "_token": "{{ csrf_token() }}",
                        'quantity': quantity
                    },
                    success: function(response) {
                        console.log(response);
                        // Update the quantity in the database
                    },
                    // error: function(xhr, status, error) {
                    //     console.log(xhr.responseText);
                    // }
                });
            }
        </script>
    </div>
</body>
</html>
 -->
 <!-- web.php -->
 <?php
//use Illuminate\Support\Facades\DB;
use App\Http\Middleware\Shopmid;

use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Route;
use Illuminate\Support\Facades\Schema;
use App\Http\Controllers\BuyController;
use App\Http\Controllers\HomeController;
use App\Http\Controllers\ItemController;
use App\Http\Controllers\ShopController;
use App\Http\Controllers\CartsController;
use App\Http\Controllers\OrdersController;
use App\Http\Controllers\BillingController;
use App\Http\Controllers\ProductsController;
use App\Http\Controllers\UserCustmarController;


/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
|
| Here is where you can register web routes for your application. These
| routes are loaded by the RouteServiceProvider within a group which
| contains the "web" middleware group. Now create something great!
|
*/

Route::get('/', function () {
    // return view('login');
});
Route::get('/',
function(){
    return view('auth.login');
}) ;
Route::resource( '/items', ItemController::class)->middleware('auth');

Auth::routes();


Route::get('/home', [App\Http\Controllers\HomeController::class, 'index'])->name('home');
Route::post('/user_custmer', [App\http\Controllers\userCustmarController::class , 'store'])->name('userCustmar.store');
Route::get('/register', function () {
    return view('register');
});
//  Route::get('/shop',function(){ return view('shop');
// });
// Route::get('/shop', function () {
//     return view('shop.shop');
// });
//Route::get('/shop', 'ShopController@index')->name('shop.index');
// Route::get('/shop', [App\Http\Controllers\shopController::class,'ShopController'])->name('shop.index');
//Route::post('/login', [UserCustmarController::class, 'login'])->name('shopmid');
// Route::get('/shop', function(){ return view('welcome');});
Route::resource('/shop', ShopController::class)->middleware('auth');
Route::resource('/carts', CartsController::class)->middleware('auth');
Route::get('/shop/store/{id}',[CartsController::class,'store'])->middleware('auth');
 Route::get('/buy',[BuyController::class,'index'])->middleware('auth');

// route::post('/shop', function(){ return view('shop.shop');})->middleware('shopmid');
route::get('/item', function(){ return view('items');});    
Route::post('/add-to-cart', 'CartController@addToCart');
Route::get('/cart-details', 'CartController@cartDetails');
// Route::get('/billing',[BillingController::class,'index'])->middleware('auth');
Route::get('/carts/{id}',[CartsController::class,'destroy']);
Route::post('/order',[CartsController::class,'ordersave']);
Route::get('/billing',[CartsController::class,'orderbilling']);

//  Route::post('/update-quantity/{id}', [BuyController::class, 'updateQuantity'])->name('update.quantity');
// Route::put('/updatequantity/{id}', 'CartsController@updateQuantity');
Route::post('/updatequantity/{id}', [CartsController::class,'updateQuantity']);

// Route::post('/billing/{id}', 'CartsController@updateQuantity')->name('billing.updateQuantity');
// ajax
// function updateQuantity(quantity,element){
//     let final_id = element.id;
//     let maxQuantity = parseInt(element.getAttribute('max'));
//     if(quantity <1 || quantity < maxQuantity){
//         alert('Quantity invalid')
//         return;
//     }
//     $.ajaxSetup({
//         headers:{
//             'X-CSRF-TOKEN':$('meta[name="csrf-token"]').attr('content')
//         }
//     });

// }
// man ajax
// function updateQuantity(quantity, element) {
//     var final_id = element.id;
//     var maxQuantity = parseInt(element.getAttribute('max'));

//     // Check if the provided quantity is within the valid range
//     if (quantity < 1 || quantity > maxQuantity) {
//         alert("Invalid quantity!");
//         return;
//     }

//     // Update the quantity in the database via AJAX
//     $.ajaxSetup({
//         headers: {
//             'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
//         }
//     });
    
//     $.ajax({
//         url: 'updatequantity/' + final_id,
//         type: 'post',
//         data: {
//             "_token": "{{ csrf_token() }}",
//             'quantity': quantity
//         },
//         success: function(response) {
//             console.log(response);
//             // You can perform additional actions upon successful update if needed
//         },
//         error: function(xhr, status, error) {
//             console.log(xhr.responseText);
//             // Handle the error if the update fails
//         }
//     });
// }
